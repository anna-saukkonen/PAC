#!/usr/bin/env nextflow


/*
 * Defines some parameters in order to specify the refence genomes
 * and read pairs by using the command line options
 */

params.genome 		= "${baseDir}/test/chr22.fa"
params.variants 	= "${baseDir}/test/NA12877_output.phased.chr22.vcf.gz"
params.reads 		= "${baseDir}/test/NA12890_merged_{1,2}.sample5000.fq" 
params.annot 		= file("ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_19/gencode.v19.annotation.gtf.gz")


log.info """\

genome 		: $params.genome
reads 		: $params.reads
variants 	: $params.variants
annot 		: $params.annot
"""



Channel
	.fromFilePairs(params.reads)
	.into {reads_ch1; reads_ch2}



process unzip {
	input:
	  path annot from params.annot

	output:
	  path "${annot.baseName}" into files_ch

	script:

	"""
	gunzip --verbose --stdout --force ${annot} > ${annot.baseName}

	"""
}



process prepare_star_genome_index {
  tag "$genome.baseName"


  input:
    path genome from params.genome
    path unzipped_annot from files_ch
  output:
    path STARhaploid into genome_dir_ch

  script:

  """
  mkdir STARhaploid



  STAR --runMode genomeGenerate \
       --genomeDir STARhaploid \
       --genomeFastaFiles ${genome} \
       --sjdbGTFfile $unzipped_annot \
       --sjdbOverhang 74 \
       --runThreadN ${task.cpus}
  """
}





process rnaseq_mapping_star {
  tag "$id"

  


  input: 
    path genome from params.genome 
    path STARhaploid from genome_dir_ch
    set val(id), file(read1), file(read2) from reads_ch1

  output: 
    tuple \
      val(id), \
      path('NA12877.SOFT.NOTRIM.STAR.pass2.Aligned.sortedByCoord.out.bam'), \
      path('NA12877.SOFT.NOTRIM.STAR.pass2.Aligned.sortedByCoord.out.bam.bai') into aligned_bam_ch

  script: 

  """
  # Align reads to genome
  STAR --genomeDir STARhaploid \
       --readFilesIn $read1 $read2 \
       --runThreadN ${task.cpus} \
       --outSAMstrandField intronMotif \
       --outFilterMultimapNmax 30 \
       --alignIntronMax 1000000 \
       --alignMatesGapMax 1000000 \
       --outMultimapperOrder Random \
       --outSAMunmapped Within \
       --outSAMattrIHstart 0 \
       --outFilterIntronMotifs RemoveNoncanonicalUnannotated \
       --sjdbOverhang 74 \
       --outFilterMismatchNmax 8 \
       --outSAMattributes NH nM NM MD HI \
       --outSAMattrRGline  ID:$id PU:Illumina PL:Illumina LB:NA12877.SOFT.NOTRIM SM:NA12877.SOFT.NOTRIM CN:Seq_centre \
       --outSAMtype BAM SortedByCoordinate \
       --twopassMode Basic \
       --outFileNamePrefix NA12877.SOFT.NOTRIM.STAR.pass2. \
       --outSAMprimaryFlag AllBestScore

  # Index the BAM file
  samtools index NA12877.SOFT.NOTRIM.STAR.pass2.Aligned.sortedByCoord.out.bam
  """
}



